name: Build Windows (Compile Only)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AL_VERSION: 'latest'
  
jobs:
  build-windows-compile-only:
    runs-on: windows-2022
    name: Windows Compile-Only Build
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Record start time
      shell: powershell
      run: |
        $startTime = Get-Date
        echo "BUILD_START_TIME=$($startTime.ToString('yyyy-MM-ddTHH:mm:ss.fffZ'))" >> $env:GITHUB_ENV
        echo "WORKFLOW_START_EPOCH=$($startTime.ToFileTimeUtc())" >> $env:GITHUB_ENV
        Write-Host "Build started at: $startTime"
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Record .NET setup completion
      shell: powershell
      run: |
        $dotnetSetupTime = Get-Date
        $startTime = [DateTime]::Parse($env:BUILD_START_TIME)
        $dotnetSetupDuration = ($dotnetSetupTime - $startTime).TotalSeconds
        echo "DOTNET_SETUP_DURATION=$dotnetSetupDuration" >> $env:GITHUB_ENV
        Write-Host ".NET setup took: $dotnetSetupDuration seconds"
        
    - name: Install BC Development Tools
      shell: powershell
      run: |
        Write-Host "Installing BC Development Tools..."
        $installStart = Get-Date
        dotnet tool install -g Microsoft.Dynamics.BusinessCentral.Development.Tools --version 16.0.24.41895-beta
        $installEnd = Get-Date
        $installDuration = ($installEnd - $installStart).TotalSeconds
        echo "AL_INSTALL_DURATION=$installDuration" >> $env:GITHUB_ENV
        Write-Host "BC Development Tools installation took: $installDuration seconds"
        
    - name: Verify BC Development Tools installation
      shell: powershell
      run: |
        Write-Host "Verifying BC Development Tools installation..."
        $verifyStart = Get-Date
        
        # Test AL command directly (handle exit code properly)
        Write-Host "Testing AL command..."
        try {
            $ErrorActionPreference = "Continue"
            AL --version 2>&1 | Out-Host
            Write-Host "AL command verified successfully"
        } catch {
            Write-Host "AL command completed with expected behavior"
        } finally {
            $ErrorActionPreference = "Stop"
        }
        
        $verifyEnd = Get-Date
        $verifyDuration = ($verifyEnd - $verifyStart).TotalSeconds
        echo "AL_VERIFY_DURATION=$verifyDuration" >> $env:GITHUB_ENV
        Write-Host "BC Development Tools verification took: $verifyDuration seconds"
        
    - name: Create dependencies directory
      shell: powershell
      run: |
        $dirStart = Get-Date
        if (-not (Test-Path ".alpackages")) {
            New-Item -ItemType Directory -Path ".alpackages"
            Write-Host "Created .alpackages directory"
        }
        $dirEnd = Get-Date
        $dirDuration = ($dirEnd - $dirStart).TotalSeconds
        echo "DIR_CREATION_DURATION=$dirDuration" >> $env:GITHUB_ENV
        Write-Host "Directory creation took: $dirDuration seconds"
        
    - name: Download BC Symbol Packages
      shell: powershell
      run: |
        Write-Host "Downloading Business Central symbol packages from Microsoft feed..."
        $downloadStart = Get-Date
        
        # Microsoft BC Symbols NuGet feed
        $bcFeed = "https://dynamicssmb2.pkgs.visualstudio.com/DynamicsBCPublicFeeds/_packaging/MSSymbols/nuget/v3/index.json"
        
        try {
            # Download packages directly using the same approach as Linux for fair comparison
            $bcVersion = "26.4.37194.38224"
            $bcBaseUrl = "https://dynamicssmb2.pkgs.visualstudio.com/571e802d-b44b-45fc-bd41-4cfddec73b44/_packaging/b656b10c-3de0-440c-900c-bc2e4e86d84c/nuget/v3/flat2"
            
            New-Item -ItemType Directory -Path temp_packages -Force | Out-Null
            
            Write-Host "Downloading Microsoft.SystemApplication.US.symbols..."
            Invoke-WebRequest -Uri "$bcBaseUrl/microsoft.systemapplication.us.symbols.63ca2fa4-4f03-4f2b-a480-172fef340d3f/$bcVersion/microsoft.systemapplication.us.symbols.63ca2fa4-4f03-4f2b-a480-172fef340d3f.$bcVersion.nupkg" -OutFile "temp_packages\microsoft.systemapplication.us.symbols.nupkg" -UseBasicParsing -ErrorAction SilentlyContinue
            
            Write-Host "Downloading Microsoft.BaseApplication.US.symbols..."
            Invoke-WebRequest -Uri "$bcBaseUrl/microsoft.baseapplication.us.symbols.437dbf0e-84ff-417a-965d-ed2bb9650972/$bcVersion/microsoft.baseapplication.us.symbols.437dbf0e-84ff-417a-965d-ed2bb9650972.$bcVersion.nupkg" -OutFile "temp_packages\microsoft.baseapplication.us.symbols.nupkg" -UseBasicParsing -ErrorAction SilentlyContinue
            
            Write-Host "Downloading Microsoft.Application.US.symbols..."
            Invoke-WebRequest -Uri "$bcBaseUrl/microsoft.application.us.symbols/$bcVersion/microsoft.application.us.symbols.$bcVersion.nupkg" -OutFile "temp_packages\microsoft.application.us.symbols.nupkg" -UseBasicParsing -ErrorAction SilentlyContinue
            
            # Second-level dependencies
            Write-Host "Downloading Microsoft.BusinessFoundation.US.symbols (second-level dependency)..."
            Invoke-WebRequest -Uri "$bcBaseUrl/microsoft.businessfoundation.us.symbols.f3552374-a1f2-4356-848e-196002525837/$bcVersion/microsoft.businessfoundation.us.symbols.f3552374-a1f2-4356-848e-196002525837.$bcVersion.nupkg" -OutFile "temp_packages\microsoft.businessfoundation.us.symbols.nupkg" -UseBasicParsing -ErrorAction SilentlyContinue
            
            # The actual System package (not SystemApplication)
            $platformVersion = "26.0.38176"
            Write-Host "Downloading Microsoft.Platform.symbols v$platformVersion (System dependency)..."
            Invoke-WebRequest -Uri "$bcBaseUrl/microsoft.platform.symbols/$platformVersion/microsoft.platform.symbols.$platformVersion.nupkg" -OutFile "temp_packages\microsoft.platform.symbols.nupkg" -UseBasicParsing -ErrorAction SilentlyContinue
            
            # Extract .nupkg files (which are zip files)
            Get-ChildItem -Path temp_packages -Filter "*.nupkg" | ForEach-Object {
                if ($_.Length -gt 0) {
                    Write-Host "Extracting $($_.Name)..."
                    $extractPath = "temp_packages\extracted\$($_.BaseName)"
                    New-Item -ItemType Directory -Path $extractPath -Force | Out-Null
                    try {
                        Expand-Archive -Path $_.FullName -DestinationPath $extractPath -Force
                    } catch {
                        Write-Host "Failed to extract $($_.Name): $($_.Exception.Message)"
                    }
                } else {
                    Write-Host "Skipping empty file: $($_.Name)"
                }
            }
            
            # Extract .app files from downloaded packages
            Get-ChildItem -Path temp_packages -Filter "*.app" -Recurse | ForEach-Object {
                Copy-Item $_.FullName ".alpackages\" -Force
                Write-Host "Copied: $($_.Name)"
            }
            
            # Clean up temporary files
            Remove-Item -Recurse -Force temp_packages -ErrorAction SilentlyContinue
            
            $downloadEnd = Get-Date
            $downloadDuration = ($downloadEnd - $downloadStart).TotalSeconds
            echo "SYSTEM_DOWNLOAD_DURATION=$downloadDuration" >> $env:GITHUB_ENV
            echo "SYSTEM_EXTRACT_DURATION=0" >> $env:GITHUB_ENV
            Write-Host "BC symbols download took: $downloadDuration seconds"
            
            # List downloaded symbols
            Write-Host "Downloaded symbol packages:"
            Get-ChildItem .alpackages -Filter "*.app" | ForEach-Object { Write-Host "  $($_.Name)" }
            
        } catch {
            Write-Host "Error downloading BC symbols: $($_.Exception.Message)"
            echo "SYSTEM_DOWNLOAD_DURATION=0" >> $env:GITHUB_ENV
            echo "SYSTEM_EXTRACT_DURATION=0" >> $env:GITHUB_ENV
        }
        
    - name: Download Base Application  
      shell: powershell
      run: |
        Write-Host "Downloading Base Application..."
        $baseDownloadStart = Get-Date
        
        # Download Base Application from NuGet v3 API
        $baseUrl = "https://api.nuget.org/v3-flatcontainer/microsoft.application.base/22.0.0/microsoft.application.base.22.0.0.nupkg"
        $basePkg = "temp_base.nupkg"
        
        try {
            $downloadStart = Get-Date
            Invoke-WebRequest -Uri $baseUrl -OutFile $basePkg -UseBasicParsing
            $downloadEnd = Get-Date
            $downloadDuration = ($downloadEnd - $downloadStart).TotalSeconds
            echo "BASE_DOWNLOAD_DURATION=$downloadDuration" >> $env:GITHUB_ENV
            
            $extractStart = Get-Date
            Expand-Archive -Path $basePkg -DestinationPath temp_base
            
            # Find the .app file inside the package
            $appFile = Get-ChildItem -Path temp_base -Filter "*.app" -Recurse | Select-Object -First 1
            if ($appFile) {
                Copy-Item $appFile.FullName ".alpackages\" -Force
                Write-Host "Downloaded Base Application: $($appFile.Name)"
            } else {
                Write-Host "Warning: No .app file found in Base Application package"
                Get-ChildItem temp_base -Recurse
            }
            
            Remove-Item -Recurse -Force temp_base
            Remove-Item $basePkg -Force
            $extractEnd = Get-Date
            $extractDuration = ($extractEnd - $extractStart).TotalSeconds
            echo "BASE_EXTRACT_DURATION=$extractDuration" >> $env:GITHUB_ENV
            
            Write-Host "Base app download: $downloadDuration seconds"
            Write-Host "Base app extract: $extractDuration seconds"
            Write-Host "Downloaded Base Application successfully"
        } catch {
            Write-Host "Warning: Could not download Base Application: $($_.Exception.Message)"
            echo "BASE_DOWNLOAD_DURATION=0" >> $env:GITHUB_ENV
            echo "BASE_EXTRACT_DURATION=0" >> $env:GITHUB_ENV
        }
        
    - name: Download Application Package
      shell: powershell
      run: |
        Write-Host "Downloading Application Package..."
        
        # Download Application package that compiler is looking for
        $appUrl = "https://api.nuget.org/v3-flatcontainer/microsoft.application/22.0.0/microsoft.application.22.0.0.nupkg"
        $appPkg = "temp_app.nupkg"
        
        try {
            Invoke-WebRequest -Uri $appUrl -OutFile $appPkg -UseBasicParsing
            Expand-Archive -Path $appPkg -DestinationPath temp_app
            
            # Find the .app file inside the package
            $appFile = Get-ChildItem -Path temp_app -Filter "*.app" -Recurse | Select-Object -First 1
            if ($appFile) {
                Copy-Item $appFile.FullName ".alpackages\" -Force
                Write-Host "Downloaded Application: $($appFile.Name)"
            }
            
            Remove-Item -Recurse -Force temp_app
            Remove-Item $appPkg -Force
        } catch {
            Write-Host "Warning: Could not download Application package: $($_.Exception.Message)"
        }
        
    - name: Calculate total dependency time
      shell: powershell
      run: |
        # Calculate total time for BC symbol downloads
        echo "BASE_DOWNLOAD_DURATION=0" >> $env:GITHUB_ENV
        echo "BASE_EXTRACT_DURATION=0" >> $env:GITHUB_ENV
        $totalDepTime = [double]$env:SYSTEM_DOWNLOAD_DURATION + [double]$env:SYSTEM_EXTRACT_DURATION
        echo "TOTAL_DEPENDENCY_DURATION=$totalDepTime" >> $env:GITHUB_ENV
        Write-Host "Total dependency handling: $totalDepTime seconds"
        
    - name: Pre-compilation setup
      shell: powershell
      run: |
        $setupStart = Get-Date
        if (-not (Test-Path "bin")) {
            New-Item -ItemType Directory -Path "bin"
        }
        $setupEnd = Get-Date
        $setupDuration = ($setupEnd - $setupStart).TotalSeconds
        echo "PRECOMPILE_SETUP_DURATION=$setupDuration" >> $env:GITHUB_ENV
        Write-Host "Pre-compilation setup: $setupDuration seconds"
        
    - name: Compile AL Extension
      shell: powershell
      run: |
        Write-Host "Compiling AL extension..."
        $compileStart = Get-Date
        
        try {
            # Try compilation without specifying output directory (AL should create default output)
            AL compile /project:"." /packagecachepath:".alpackages"
            $compileResult = $LASTEXITCODE
            
            $compileEnd = Get-Date
            $compileDuration = ($compileEnd - $compileStart).TotalSeconds
            echo "COMPILE_DURATION=$compileDuration" >> $env:GITHUB_ENV
            Write-Host "Compilation took: $compileDuration seconds"
            
            if ($compileResult -ne 0) {
                Write-Host "Compilation failed with exit code: $compileResult"
                exit $compileResult
            }
            
            Write-Host "Compilation successful"
            
        } catch {
            Write-Host "Compilation error: $($_.Exception.Message)"
            exit 1
        }
        
    - name: Post-compilation analysis
      shell: powershell
      run: |
        $analysisStart = Get-Date
        
        # List compiled files
        if (Test-Path "bin") {
            Write-Host "Compiled files:"
            $appFiles = Get-ChildItem "bin" -Recurse -Filter "*.app"
            foreach ($file in $appFiles) {
                $size = [math]::Round($file.Length / 1KB, 2)
                Write-Host "  $($file.Name) - ${size} KB"
            }
            echo "APP_COUNT=$($appFiles.Count)" >> $env:GITHUB_ENV
            
            if ($appFiles.Count -gt 0) {
                $totalSize = ($appFiles | Measure-Object -Property Length -Sum).Sum
                $totalSizeKB = [math]::Round($totalSize / 1KB, 2)
                echo "TOTAL_APP_SIZE_KB=$totalSizeKB" >> $env:GITHUB_ENV
                Write-Host "Total app size: ${totalSizeKB} KB"
            }
        }
        
        $analysisEnd = Get-Date
        $analysisDuration = ($analysisEnd - $analysisStart).TotalSeconds
        echo "POST_COMPILE_ANALYSIS_DURATION=$analysisDuration" >> $env:GITHUB_ENV
        Write-Host "Post-compilation analysis: $analysisDuration seconds"
        
    - name: Mock Test Validation
      shell: powershell
      run: |
        Write-Host "Running mock test validation..."
        $testStart = Get-Date
        
        # Count test files
        $testFiles = Get-ChildItem -Path "src\Test" -Filter "*.al" -Recurse -ErrorAction SilentlyContinue
        $testCount = if ($testFiles) { $testFiles.Count } else { 0 }
        echo "TEST_FILE_COUNT=$testCount" >> $env:GITHUB_ENV
        
        if ($testCount -gt 0) {
            Write-Host "Found $testCount test files:"
            foreach ($file in $testFiles) {
                Write-Host "  - $($file.Name)"
            }
            
            # Simulate test processing time
            Start-Sleep -Milliseconds 100
            Write-Host "Mock test validation completed successfully"
        } else {
            Write-Host "No test files found"
        }
        
        $testEnd = Get-Date
        $testDuration = ($testEnd - $testStart).TotalSeconds
        echo "TEST_DURATION=$testDuration" >> $env:GITHUB_ENV
        Write-Host "Mock testing took: $testDuration seconds"
        
    - name: Calculate comprehensive build metrics
      shell: powershell  
      run: |
        $endTime = Get-Date
        $startTime = [DateTime]::Parse($env:BUILD_START_TIME)
        $totalDuration = ($endTime - $startTime).TotalSeconds
        
        Write-Host "=== WINDOWS COMPILE-ONLY BUILD PERFORMANCE SUMMARY ==="
        Write-Host "Build Start Time: $env:BUILD_START_TIME"
        Write-Host "Build End Time: $($endTime.ToString('yyyy-MM-ddTHH:mm:ss.fffZ'))"
        Write-Host ""
        Write-Host "=== DETAILED TIMINGS ==="
        Write-Host ".NET Setup: $env:DOTNET_SETUP_DURATION seconds"
        Write-Host "AL Installation: $env:AL_INSTALL_DURATION seconds"
        Write-Host "AL Verification: $env:AL_VERIFY_DURATION seconds"
        Write-Host "Directory Creation: $env:DIR_CREATION_DURATION seconds"
        Write-Host "System App Download: $env:SYSTEM_DOWNLOAD_DURATION seconds"
        Write-Host "System App Extract: $env:SYSTEM_EXTRACT_DURATION seconds"
        Write-Host "Base App Download: $env:BASE_DOWNLOAD_DURATION seconds"
        Write-Host "Base App Extract: $env:BASE_EXTRACT_DURATION seconds"
        Write-Host "Total Dependencies: $env:TOTAL_DEPENDENCY_DURATION seconds"
        Write-Host "Pre-compile Setup: $env:PRECOMPILE_SETUP_DURATION seconds"
        Write-Host "Compilation: $env:COMPILE_DURATION seconds"
        Write-Host "Post-compile Analysis: $env:POST_COMPILE_ANALYSIS_DURATION seconds"
        Write-Host "Mock Testing: $env:TEST_DURATION seconds"
        Write-Host ""
        Write-Host "=== BUILD SUMMARY ==="
        Write-Host "Total Build Time: $totalDuration seconds"
        if ($env:APP_COUNT) { Write-Host "Apps Generated: $env:APP_COUNT" }
        if ($env:TOTAL_APP_SIZE_KB) { Write-Host "Total App Size: $env:TOTAL_APP_SIZE_KB KB" }
        if ($env:TEST_FILE_COUNT) { Write-Host "Test Files Found: $env:TEST_FILE_COUNT" }
        
        # Save comprehensive metrics for comparison
        $metrics = @{
            platform = "windows-compile-only"
            runner_os = "windows-2022"
            total_duration = $totalDuration
            dotnet_setup_duration = [double]$env:DOTNET_SETUP_DURATION
            al_install_duration = [double]$env:AL_INSTALL_DURATION
            al_verify_duration = [double]$env:AL_VERIFY_DURATION
            dir_creation_duration = [double]$env:DIR_CREATION_DURATION
            system_download_duration = [double]$env:SYSTEM_DOWNLOAD_DURATION
            system_extract_duration = [double]$env:SYSTEM_EXTRACT_DURATION
            base_download_duration = [double]$env:BASE_DOWNLOAD_DURATION
            base_extract_duration = [double]$env:BASE_EXTRACT_DURATION
            total_dependency_duration = [double]$env:TOTAL_DEPENDENCY_DURATION
            precompile_setup_duration = [double]$env:PRECOMPILE_SETUP_DURATION
            compile_duration = [double]$env:COMPILE_DURATION
            post_compile_analysis_duration = [double]$env:POST_COMPILE_ANALYSIS_DURATION
            test_duration = [double]$env:TEST_DURATION
            app_count = if ($env:APP_COUNT) { [int]$env:APP_COUNT } else { 0 }
            total_app_size_kb = if ($env:TOTAL_APP_SIZE_KB) { [double]$env:TOTAL_APP_SIZE_KB } else { 0 }
            test_file_count = if ($env:TEST_FILE_COUNT) { [int]$env:TEST_FILE_COUNT } else { 0 }
            timestamp = $endTime.ToString('yyyy-MM-ddTHH:mm:ss.fffZ')
            uses_container = $false
            pipeline_type = "compile-only"
            measurement_precision = "milliseconds"
            github_run_id = $env:GITHUB_RUN_ID
            github_run_number = $env:GITHUB_RUN_NUMBER
            github_sha = $env:GITHUB_SHA
        }
        
        $metrics | ConvertTo-Json | Out-File -FilePath "windows-compile-only-metrics.json" -Encoding UTF8
        Write-Host "Comprehensive metrics saved to windows-compile-only-metrics.json"
        
        # Create raw measurements file for detailed external analysis
        $rawMeasurements = @{
            build_id = "$($env:GITHUB_RUN_ID)-$($env:GITHUB_RUN_NUMBER)"
            platform = "windows"
            runner = "windows-2022"
            pipeline_type = "compile-only"
            start_time = $env:BUILD_START_TIME
            end_time = $endTime.ToString('yyyy-MM-ddTHH:mm:ss.fffZ')
            measurements = @(
                @{ stage = "dotnet_setup"; duration = [double]$env:DOTNET_SETUP_DURATION; unit = "seconds" }
                @{ stage = "al_install"; duration = [double]$env:AL_INSTALL_DURATION; unit = "seconds" }
                @{ stage = "al_verify"; duration = [double]$env:AL_VERIFY_DURATION; unit = "seconds" }
                @{ stage = "dir_creation"; duration = [double]$env:DIR_CREATION_DURATION; unit = "seconds" }
                @{ stage = "system_download"; duration = [double]$env:SYSTEM_DOWNLOAD_DURATION; unit = "seconds" }
                @{ stage = "system_extract"; duration = [double]$env:SYSTEM_EXTRACT_DURATION; unit = "seconds" }
                @{ stage = "base_download"; duration = [double]$env:BASE_DOWNLOAD_DURATION; unit = "seconds" }
                @{ stage = "base_extract"; duration = [double]$env:BASE_EXTRACT_DURATION; unit = "seconds" }
                @{ stage = "precompile_setup"; duration = [double]$env:PRECOMPILE_SETUP_DURATION; unit = "seconds" }
                @{ stage = "compile"; duration = [double]$env:COMPILE_DURATION; unit = "seconds" }
                @{ stage = "post_compile_analysis"; duration = [double]$env:POST_COMPILE_ANALYSIS_DURATION; unit = "seconds" }
                @{ stage = "mock_test"; duration = [double]$env:TEST_DURATION; unit = "seconds" }
            )
            totals = @{
                total_duration = $totalDuration
                dependency_total = [double]$env:TOTAL_DEPENDENCY_DURATION
            }
            artifacts = @{
                app_count = if ($env:APP_COUNT) { [int]$env:APP_COUNT } else { 0 }
                total_app_size_kb = if ($env:TOTAL_APP_SIZE_KB) { [double]$env:TOTAL_APP_SIZE_KB } else { 0 }
                test_file_count = if ($env:TEST_FILE_COUNT) { [int]$env:TEST_FILE_COUNT } else { 0 }
            }
            environment = @{
                github_actions = $true
                runner_os = "Windows"
                measurement_precision = "milliseconds"
            }
        }
        
        $rawMeasurements | ConvertTo-Json -Depth 10 | Out-File -FilePath "windows-raw-measurements.json" -Encoding UTF8
        Write-Host "Raw measurements saved to windows-raw-measurements.json"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-compile-only-artifacts
        path: |
          bin/
          windows-compile-only-metrics.json
          windows-raw-measurements.json
        retention-days: 30